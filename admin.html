<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ðŸŽ¨ ArtFrenzy Admin</title>
<style>
/* Base */
body { margin:0; font-family:'Segoe UI', sans-serif; background:#111; color:#eee; }
header { padding:1rem; text-align:center; border-bottom:2px solid #333; background:#000; }
header h1 {
  font-size:2rem; font-weight:bold;
  background: linear-gradient(90deg, red, orange, yellow, green, blue);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
nav { display:flex; flex-wrap:wrap; justify-content:center; gap:.5rem; margin-top:1rem; }
nav button {
  background:#222; color:#fff; border:1px solid #444; padding:.5rem 1rem; cursor:pointer; border-radius:5px; transition: background .2s;
}
nav button:hover { background:#444; }
main { padding:1rem; }
section { display:none; }
section.active { display:block; animation:fadeIn .3s ease-in; }

table { width:100%; border-collapse:collapse; margin-top:1rem; }
table th, table td { border:1px solid #444; padding:.5rem; text-align:left; }
table img { max-width:50px; border-radius:3px; }
table td input { background:#222; color:#fff; border:1px solid #444; width:100%; padding:.25rem; border-radius:3px; }

form { display:grid; gap:.5rem; margin-bottom:2rem; }
input, button { padding:.5rem; border-radius:4px; border:none; }
input { background:#222; color:#fff; border:1px solid #444; }
button[type="submit"] { background:#444; color:#fff; cursor:pointer; }
button[type="submit"]:hover { background:#666; }

@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

/* Toast */
#toast-container { position:fixed; top:1rem; right:1rem; z-index:9999; }
.toast {
  background:#222; color:#fff; padding:.75rem 1rem; margin-bottom:.5rem;
  border-radius:5px; box-shadow:0 0 5px #000; opacity:0.95; min-width:200px;
}

/* Mobile */
@media(max-width:600px){ nav{flex-direction:column;} table, th, td{font-size:.9rem;} }
</style>
</head>
<body>
<header>
  <h1>ðŸŽ¨ ArtFrenzy Admin</h1>
  <nav>
    <button onclick="showSection('products')">Products</button>
    <button onclick="showSection('purchases')">Purchases</button>
    <button onclick="window.open('client.html','_blank')">View Client Site</button>
  </nav>
</header>

<main>
<section id="products" class="active">
  <h2>Create New Product</h2>
  <form id="productForm">
    <input type="file" accept="image/*" id="productImage" required>
    <input type="text" id="productTitle" placeholder="Title" required>
    <input type="number" id="productPrice" placeholder="Price (KES)" required>
    <input type="number" id="productStock" placeholder="Stock" required>
    <button type="submit">Publish Product</button>
  </form>

  <h2>All Products</h2>
  <table>
    <thead>
      <tr><th>Image</th><th>Title</th><th>Price</th><th>Stock</th><th>Time</th><th>Actions</th></tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>
</section>

<section id="purchases">
  <h2>Recent Purchases</h2>
  <table>
    <thead>
      <tr><th>Product</th><th>Buyer</th><th>Price</th><th>Location</th><th>Date</th></tr>
    </thead>
    <tbody id="purchaseTableBody"></tbody>
  </table>
</section>
</main>

<div id="toast-container"></div>

<script>
const API_BASE = "https://art-frenzy-admin-3.onrender.com";

// Toast
function showToast(msg,duration=3000){
  const container=document.getElementById('toast-container');
  const toast=document.createElement('div'); toast.className='toast'; toast.innerText=msg;
  container.appendChild(toast); setTimeout(()=>toast.remove(),duration);
}

// Section toggle
function showSection(id){ document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
document.getElementById(id).classList.add('active'); }

// Load products
async function loadProducts(){
  const tbody=document.getElementById("productTableBody"); tbody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>";
  try{
    const res=await fetch(`${API_BASE}/admin/products`);
    const products=await res.json();
    tbody.innerHTML=products.map(p=>`
      <tr>
        <td><img src="${p.image_url}" alt="${p.title}"></td>
        <td><input value="${p.title}" disabled></td>
        <td><input value="${p.price}" data-id="${p.id}" data-field="price" class="editable"></td>
        <td><input value="${p.stock}" data-id="${p.id}" data-field="stock" class="editable"></td>
        <td>${new Date(p.created_at).toLocaleString()}</td>
        <td>
          <button onclick="deleteProduct(${p.id})">Delete</button>
        </td>
      </tr>
    `).join('');

    document.querySelectorAll('.editable').forEach(input=>{
      input.addEventListener('change', async e=>{
        const id=input.dataset.id, field=input.dataset.field, value=input.value;
        try{
          const res=await fetch(`${API_BASE}/admin/update-product/${id}`,{
            method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({[field]:value})
          });
          const data=await res.json();
          if(res.ok) showToast('Product updated'); else showToast(data.error||'Update failed');
          loadProducts();
        }catch(err){ console.error(err); showToast('Network error'); }
      });
    });
  }catch(err){ tbody.innerHTML="<tr><td colspan='6'>Failed to load products</td></tr>"; showToast("Failed to load products"); console.error(err); }
}

// Load purchases
async function loadPurchases(){
  const tbody=document.getElementById("purchaseTableBody"); tbody.innerHTML="<tr><td colspan='5'>Loading...</td></tr>";
  try{
    const res=await fetch(`${API_BASE}/admin/purchases`);
    const purchases=await res.json();
    tbody.innerHTML=purchases.map(p=>`
      <tr>
        <td>${p.product_title}</td>
        <td>${p.buyer_name}<br>${p.buyer_phone}</td>
        <td>${p.product_price}</td>
        <td>${p.drop_location}</td>
        <td>${new Date(p.purchase_time).toLocaleString()}</td>
      </tr>
    `).join('');
  }catch(err){ tbody.innerHTML="<tr><td colspan='5'>Failed to load purchases</td></tr>"; showToast("Failed to load purchases"); console.error(err); }
}

// Add product
document.getElementById("productForm").addEventListener("submit", e=>{
  e.preventDefault();
  const title=document.getElementById("productTitle").value;
  const price=document.getElementById("productPrice").value;
  const stock=document.getElementById("productStock").value;
  const file=document.getElementById("productImage").files[0];
  if(!file) return showToast("Select an image");
  const reader=new FileReader();
  reader.onload=async ()=>{
    const payload={title, price, stock, image:reader.result, filename:file.name};
    try{
      const res=await fetch(`${API_BASE}/admin/add-product`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      const data=await res.json();
      if(res.ok){ showToast("Product added"); document.getElementById("productForm").reset(); loadProducts(); }
      else showToast(data.error||"Failed to add product");
    }catch(err){ console.error(err); showToast("Network error"); }
  };
  reader.readAsDataURL(file);
});

// Delete product
async function deleteProduct(id){
  if(!confirm("Delete this product?")) return;
  try{
    const res=await fetch(`${API_BASE}/admin/delete-product/${id}`,{method:'DELETE'});
    const data=await res.json();
    if(res.ok) showToast("Product deleted"); else showToast(data.error||"Failed to delete");
    loadProducts();
  }catch(err){ console.error(err); showToast("Network error"); }
}

// Initial load
loadProducts(); loadPurchases();
</script>
</body>
</html>
