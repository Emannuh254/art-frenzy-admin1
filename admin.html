<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ðŸŽ¨ ArtFrenzy Admin</title>
<style>
  /* --- Global Styles --- */
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #111;
    color: #eee;
  }
  h1,h2 { margin: 0; }
  header {
    padding: 1rem;
    background-color: #000;
    text-align: center;
    border-bottom: 2px solid #333;
  }
  header h1 {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(90deg, red, orange, yellow, green, blue);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* --- Navigation --- */
  nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: .5rem;
    margin-top: 1rem;
  }
  nav button {
    background-color: #222;
    color: #fff;
    border: 1px solid #444;
    padding: .5rem 1rem;
    cursor: pointer;
    border-radius: 5px;
    transition: background .2s;
  }
  nav button:hover { background-color: #444; }

  /* --- Main --- */
  main { padding: 1rem; }
  section { display: none; }
  section.active { display: block; animation: fadeIn .3s ease-in; }

  /* --- Table --- */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  table th, table td {
    border: 1px solid #444;
    padding: .5rem;
    text-align: left;
  }
  table img { max-width: 50px; border-radius: 3px; }
  button.delete-btn {
    background-color: #900;
    color: #fff;
    border: none;
    padding: .3rem .6rem;
    border-radius: 3px;
    cursor: pointer;
  }
  button.delete-btn:hover { background-color: #c00; }

  /* --- Form --- */
  form {
    display: grid;
    gap: .5rem;
    margin-bottom: 2rem;
  }
  input, button[type="submit"] {
    padding: .5rem;
    border-radius: 4px;
  }
  input {
    background-color: #222;
    color: #fff;
    border: 1px solid #444;
  }
  button[type="submit"] {
    background-color: #444;
    color: #fff;
    cursor: pointer;
    border: none;
  }
  button[type="submit"]:hover { background-color: #666; }

  /* --- Toast --- */
  #toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background-color: #222;
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 5px;
    display: none;
    z-index: 1000;
    box-shadow: 0 0 10px #000;
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* --- Mobile --- */
  @media (max-width: 600px) {
    nav { flex-direction: column; }
    table, th, td { font-size: .9rem; }
  }
</style>
</head>
<body>

<header>
  <h1>ðŸŽ¨ ArtFrenzy Admin</h1>
  <nav>
    <button onclick="showSection('products')">Products</button>
    <button onclick="showSection('purchases')">Purchases</button>
    <button onclick="window.open('client.html','_blank')">View Client Site</button>
  </nav>
</header>

<main>
  <!-- Products Section -->
  <section id="products" class="section active">
    <h2>Create New Product</h2>
    <form id="productForm">
      <input type="file" accept="image/*" id="productImage" required>
      <input type="text" id="productTitle" placeholder="Title" required>
      <input type="number" id="productPrice" placeholder="Price (KES)" required>
      <input type="number" id="productStock" placeholder="Stock" required>
      <button type="submit">Publish Product</button>
    </form>

    <h2>All Products</h2>
    <table>
      <thead>
        <tr>
          <th>Image</th><th>Title</th><th>Price</th><th>Stock</th><th>Time</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="productTableBody"></tbody>
    </table>
  </section>

  <!-- Purchases Section -->
  <section id="purchases" class="section">
    <h2>Recent Purchases</h2>
    <table>
      <thead>
        <tr><th>Product</th><th>Buyer</th><th>Price</th><th>Location</th><th>Date</th></tr>
      </thead>
      <tbody id="purchaseTableBody"></tbody>
    </table>
  </section>
</main>

<!-- Toast -->
<div id="toast"></div>

<script>
const API_BASE = "https://art-frenzy-admin-3.onrender.com/admin";

// --- Toast Function ---
function showToast(msg, success=true) {
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.style.backgroundColor = success ? "#222" : "#900";
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 3500);
}

// --- Section Toggle ---
function showSection(id) {
  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// --- Load Products ---
async function loadProducts() {
  const tbody = document.getElementById("productTableBody");
  tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
  try {
    const res = await fetch(`${API_BASE}/products`);
    const products = await res.json();
    tbody.innerHTML = products.map(p => `
      <tr>
        <td><img src="${p.image_url}" alt="${p.title}"></td>
        <td>${p.title}</td>
        <td>${p.price}</td>
        <td>${p.stock}</td>
        <td>${new Date(p.created_at).toLocaleString()}</td>
        <td><button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button></td>
      </tr>
    `).join("");
  } catch (err) {
    tbody.innerHTML = "<tr><td colspan='6'>Failed to load products</td></tr>";
    console.error(err);
    showToast("Failed to load products", false);
  }
}

// --- Load Purchases ---
async function loadPurchases() {
  const tbody = document.getElementById("purchaseTableBody");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
  try {
    const res = await fetch(`${API_BASE}/purchases`);
    const purchases = await res.json();
    tbody.innerHTML = purchases.map(p => `
      <tr>
        <td>${p.product_title}</td>
        <td>${p.buyer_name}<br>${p.buyer_phone}</td>
        <td>${p.product_price}</td>
        <td>${p.drop_location}</td>
        <td>${new Date(p.purchase_time).toLocaleString()}</td>
      </tr>
    `).join("");
  } catch (err) {
    tbody.innerHTML = "<tr><td colspan='5'>Failed to load purchases</td></tr>";
    console.error(err);
    showToast("Failed to load purchases", false);
  }
}

// --- Add Product ---
document.getElementById("productForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = document.getElementById("productTitle").value;
  const price = parseFloat(document.getElementById("productPrice").value);
  const stock = parseInt(document.getElementById("productStock").value);
  const file = document.getElementById("productImage").files[0];

  if (!file) return showToast("Select an image", false);

  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result;
    const payload = { title, price, stock, image: base64, filename: file.name };

    try {
      const res = await fetch(`${API_BASE}/add-product`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok) {
        showToast("Product added successfully!");
        document.getElementById("productForm").reset();
        loadProducts();
      } else {
        showToast(data.error || "Failed to add product", false);
      }
    } catch (err) {
      console.error(err);
      showToast("Network error", false);
    }
  };
  reader.readAsDataURL(file);
});

// --- Delete Product ---
async function deleteProduct(id) {
  if (!confirm("Delete this product?")) return;
  try {
    const res = await fetch(`${API_BASE}/delete-product/${id}`, { method: "DELETE" });
    const data = await res.json();
    if (res.ok) {
      showToast("Product deleted!");
      loadProducts();
    } else {
      showToast(data.error || "Failed to delete product", false);
    }
  } catch (err) {
    console.error(err);
    showToast("Failed to delete product", false);
  }
}

// --- Initial Load ---
loadProducts();
loadPurchases();
</script>
</body>
</html>
